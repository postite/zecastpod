<?php
/**
 * Generated by Haxe 4.0.0 (git build development @ 3018ab1)
 */

namespace tink\http;

use \tink\core\OutcomeTools;
use \tink\core\Outcome;
use \haxe\ds\StringMap;
use \php\Boot;
use \tink\core\_Outcome\OutcomeMapper_Impl_;
use \php\_Boot\HxException;
use \tink\core\TypedError;
use \tink\_Url\Url_Impl_;
use \tink\url\_Query\QueryStringParser;
use \php\_NativeArray\NativeArrayIterator;
use \tink\url\_Portion\Portion_Impl_;
use \php\_Boot\HxString;
use \haxe\io\_BytesData\Container as _BytesDataContainer;
use \haxe\io\Bytes;
use \tink\http\_Header\HeaderName_Impl_;
use \tink\io\StreamParserObject;
use \php\_Boot\HxAnon;

class IncomingRequestHeader extends RequestHeader {
	/**
	 * @var StringMap
	 */
	public $cookies;


	/**
	 *  Get a StreamParser which can parse a Source into an IncomingRequestHeader
	 * 
	 * @return StreamParserObject
	 */
	static public function parser () {
		#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:90: lines 90-97
		return new HeaderParser(function ($line, $headers) {
			#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:91: characters 21-36
			$_g = \Array_hx::wrap(explode(" ", $line));
			#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:91: characters 21-36
			if ($_g->length === 3) {
				#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:92: characters 28-36
				$protocol = ($_g->arr[2] ?? null);
				#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:92: characters 15-21
				$method = ($_g->arr[0] ?? null);
				#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:93: characters 11-82
				return Outcome::Success(new IncomingRequestHeader($method, Url_Impl_::fromString(($_g->arr[1] ?? null)), $protocol, $headers));
			} else {
				#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:95: characters 11-73
				return Outcome::Failure(new TypedError(422, "Invalid HTTP header", new HxAnon([
					"fileName" => "tink/http/Request.hx",
					"lineNumber" => 95,
					"className" => "tink.http.IncomingRequestHeader",
					"methodName" => "parser",
				])));
			}
		});
	}


	/**
	 * @param string $method
	 * @param object $url
	 * @param string $protocol
	 * @param \Array_hx $fields
	 * 
	 * @return void
	 */
	public function __construct ($method, $url, $protocol = null, $fields) {
		#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:35: lines 35-111
		parent::__construct($method, $url, $protocol, $fields);
	}


	/**
	 * @param \Array_hx $fields
	 * 
	 * @return IncomingRequestHeader
	 */
	public function concat ($fields) {
		#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:47: characters 38-44
		$tmp = $this->method;
		#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:47: characters 46-49
		$tmp1 = $this->url;
		#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:47: characters 51-59
		$tmp2 = $this->protocol;
		#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:47: characters 5-88
		return new IncomingRequestHeader($tmp, $tmp1, $tmp2, $this->fields->concat($fields));
	}


	/**
	 *  List all cookie names
	 * 
	 * @return object
	 */
	public function cookieNames () {
		#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:53: characters 12-26
		return new NativeArrayIterator(array_map("strval", array_keys($this->cookies->data)));
	}


	/**
	 *  Get the Authorization header as an Enum
	 * 
	 * @return Outcome
	 */
	public function getAuth () {
		#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:65: lines 65-76
		return $this->getAuthWith(function ($s, $p)  use (&$e) {
			#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:65: lines 65-76
			switch ($s) {
				case "Basic":
					#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:67: characters 9-138
					$decoded = null;
					#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:67: characters 23-137
					try {
						#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:67: characters 27-43
						$s1 = base64_decode($p, true);
						#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:67: characters 9-138
						$decoded = (new Bytes(strlen($s1), new _BytesDataContainer($s1)))->toString();
					} catch (\Throwable $__hx__caught_e) {
						$__hx__real_e = ($__hx__caught_e instanceof HxException ? $__hx__caught_e->e : $__hx__caught_e);
						$e = $__hx__real_e;
						#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:67: characters 72-137
						return Outcome::Failure(TypedError::withData(null, "Error in decoding basic auth", $e, new HxAnon([
							"fileName" => "tink/http/Request.hx",
							"lineNumber" => 67,
							"className" => "tink.http.IncomingRequestHeader",
							"methodName" => "getAuth",
						])));
					}
					#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:68: characters 16-36
					$_g = HxString::indexOf($decoded, ":");
					#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:68: characters 16-36
					if ($_g === -1) {
						#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:69: characters 20-99
						return Outcome::Failure(new TypedError(null, "Cannot parse username and password because \":\" is missing", new HxAnon([
							"fileName" => "tink/http/Request.hx",
							"lineNumber" => 69,
							"className" => "tink.http.IncomingRequestHeader",
							"methodName" => "getAuth",
						])));
					} else {
						#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:70: characters 19-78
						return Outcome::Success(Authorization::Basic(HxString::substr($decoded, 0, $_g), HxString::substr($decoded, $_g + 1)));
					}
					break;
				case "Bearer":
					#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:73: characters 9-27
					return Outcome::Success(Authorization::Bearer($p));
					break;
				default:
					#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:75: characters 9-30
					return Outcome::Success(Authorization::Others($s, $p));
					break;
			}
		});
	}


	/**
	 * @param \Closure $parser
	 * 
	 * @return Outcome
	 */
	public function getAuthWith ($parser) {
		#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:79: lines 79-84
		return OutcomeTools::flatMap($this->byName("authorization"), OutcomeMapper_Impl_::withSameError(function ($v)  use (&$parser) {
			#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:79: characters 75-89
			$_g = HxString::indexOf($v, " ");
			#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:79: characters 75-89
			if ($_g === -1) {
				#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:81: characters 11-82
				return Outcome::Failure(new TypedError(422, "Invalid Authorization Header", new HxAnon([
					"fileName" => "tink/http/Request.hx",
					"lineNumber" => 81,
					"className" => "tink.http.IncomingRequestHeader",
					"methodName" => "getAuthWith",
				])));
			} else {
				#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:83: characters 11-50
				return $parser(HxString::substr($v, 0, $_g), HxString::substr($v, $_g + 1));
			}
		}));
	}


	/**
	 *  Get a single cookie
	 * 
	 * @param string $name
	 * 
	 * @return string
	 */
	public function getCookie ($name) {
		#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:59: characters 12-30
		return ($this->getCookies()->data[$name] ?? null);
	}


	/**
	 * @return StringMap
	 */
	public function getCookies () {
		#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:40: lines 40-41
		if ($this->cookies === null) {
			#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:41: characters 17-131
			$_g = new StringMap();
			#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:41: characters 18-130
			$_g1 = 0;
			#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:41: characters 18-130
			$_g2 = $this->get(HeaderName_Impl_::ofString("cookie"));
			#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:41: characters 18-130
			while ($_g1 < $_g2->length) {
				#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:41: characters 23-29
				$header = ($_g2->arr[$_g1] ?? null);
				#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:41: characters 18-130
				$_g1 = $_g1 + 1;
				#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:41: characters 62-92
				$entry = new QueryStringParser($header, ";", "=", 0);
				#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:41: characters 62-92
				while ($entry->hasNext()) {
					#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:41: characters 48-130
					$entry1 = $entry->next();
					#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:41: characters 94-130
					$key = $entry1->name;
					#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:41: characters 94-130
					$value = Portion_Impl_::toString($entry1->value);
					#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:41: characters 94-130
					$_g->data[$key] = $value;
				}

			}

			#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:41: characters 7-131
			$this->cookies = $_g;
		}
		#/Users/ut/haxe/haxe_libraries/tink_http/0.8.2/github/403eb075dff5d7b8ec4a9e08052eb01e1e196722/src/tink/http/Request.hx:43: characters 5-19
		return $this->cookies;
	}
}


Boot::registerClass(IncomingRequestHeader::class, 'tink.http.IncomingRequestHeader');
