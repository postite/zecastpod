<?php
/**
 * Generated by Haxe 4.0.0 (git build development @ 3018ab1)
 */

namespace tink\io\std;

use \haxe\io\Eof;
use \php\Boot;
use \php\_Boot\HxException;
use \tink\io\_Worker\Worker_Impl_;
use \tink\io\WorkerObject;
use \tink\core\TypedError;
use \haxe\io\Input;
use \tink\core\_Future\Future_Impl_;
use \tink\streams\Generator;
use \tink\streams\Step;
use \haxe\io\Bytes;
use \tink\chunk\ByteChunk;
use \tink\_Chunk\Chunk_Impl_;
use \tink\core\_Lazy\LazyFunc;
use \php\_Boot\HxAnon;
use \haxe\io\Error;

class InputSource extends Generator {
	/**
	 * @param string $name
	 * @param Input $target
	 * @param WorkerObject $worker
	 * @param Bytes $buf
	 * @param int $offset
	 * 
	 * @return void
	 */
	public function __construct ($name, $target, $worker, $buf, $offset) {
		#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/InputSource.hx:10: lines 10-11
		$next = function ($buf1, $offset1)  use (&$name, &$worker, &$target) {
			#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/InputSource.hx:11: characters 7-64
			return new InputSource($name, $target, $worker, $buf1, $offset1);
		};
		#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/InputSource.hx:13: characters 5-36
		$free = $buf->length - $offset;
		#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/InputSource.hx:15: lines 15-61
		parent::__construct(Future_Impl_::async(function ($cb)  use (&$name, &$free, &$buf, &$next, &$e1, &$worker, &$target, &$offset) {
			#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/InputSource.hx:16: lines 16-60
			Worker_Impl_::work($worker, new LazyFunc(function ()  use (&$name, &$free, &$buf, &$next, &$e1, &$target, &$offset) {
				#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/InputSource.hx:17: lines 17-51
				try {
					#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/InputSource.hx:18: characters 11-58
					$read = $target->readBytes($buf, $offset, $free);
					#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/InputSource.hx:20: lines 20-36
					if ($read === 0) {
						#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/InputSource.hx:21: characters 18-34
						$tmp = Chunk_Impl_::$EMPTY;
						#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/InputSource.hx:21: characters 13-54
						return Step::Link($tmp, $next($buf, $offset));
					} else {
						#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/InputSource.hx:24: lines 24-26
						$nextOffset = (($free - $read) < 1024 ? 0 : $offset + $read);
						#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/InputSource.hx:28: lines 28-30
						$nextBuf = ($nextOffset === 0 ? Bytes::alloc($buf->length) : $buf);
						#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/InputSource.hx:33: characters 15-55
						$tmp1 = ByteChunk::of($buf)->slice($offset, $offset + $read);
						#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/InputSource.hx:32: lines 32-35
						return Step::Link($tmp1, $next($nextBuf, $nextOffset));
					}
				} catch (\Throwable $__hx__caught_e) {
					$__hx__real_e = ($__hx__caught_e instanceof HxException ? $__hx__caught_e->e : $__hx__caught_e);
					if ($__hx__real_e instanceof Eof) {
						$e = $__hx__real_e;
						#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/InputSource.hx:39: characters 11-14
						return Step::End();
					} else if ($__hx__real_e instanceof Error) {
						$e1 = $__hx__real_e;
						#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/InputSource.hx:42: lines 42-51
						if ($e1->index === 0) {
							#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/InputSource.hx:44: characters 20-36
							$tmp2 = Chunk_Impl_::$EMPTY;
							#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/InputSource.hx:44: characters 15-56
							return Step::Link($tmp2, $next($buf, $offset));
						} else {
							#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/InputSource.hx:50: characters 15-67
							return Step::Fail(TypedError::withData(null, "Failed to read from " . ($name??'null'), $e1, new HxAnon([
								"fileName" => "tink/io/std/InputSource.hx",
								"lineNumber" => 50,
								"className" => "tink.io.std.InputSource",
								"methodName" => "new",
							])));
						}
					} else  throw $__hx__caught_e;
				}
			}))->handle(function ($step)  use (&$target, &$cb) {
				#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/InputSource.hx:53: lines 53-58
				switch ($step->index) {
					case 1:
					case 2:
						#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/InputSource.hx:55: lines 55-56
						try {
							#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/InputSource.hx:55: characters 17-31
							$target->close();
						} catch (\Throwable $__hx__caught_e) {
							$__hx__real_e = ($__hx__caught_e instanceof HxException ? $__hx__caught_e->e : $__hx__caught_e);
							$e2 = $__hx__real_e;
													}
						break;
					default:
												break;
				}
				#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/InputSource.hx:59: characters 9-17
				$cb($step);
			});
		}, true));
	}
}


Boot::registerClass(InputSource::class, 'tink.io.std.InputSource');
