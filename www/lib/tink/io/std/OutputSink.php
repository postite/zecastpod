<?php
/**
 * Generated by Haxe 4.0.0 (git build development @ 3018ab1)
 */

namespace tink\io\std;

use \haxe\io\Eof;
use \tink\streams\_Stream\Handler_Impl_;
use \tink\core\Outcome;
use \haxe\io\Output;
use \php\Boot;
use \php\_Boot\HxException;
use \tink\io\_Worker\Worker_Impl_;
use \tink\io\WorkerObject;
use \tink\core\TypedError;
use \tink\core\_Future\FutureObject;
use \tink\core\_Future\Future_Impl_;
use \tink\io\PipeResultTools;
use \tink\streams\StreamObject;
use \tink\io\SinkBase;
use \tink\chunk\ByteChunk;
use \tink\_Chunk\Chunk_Impl_;
use \tink\core\Noise;
use \tink\core\_Lazy\LazyFunc;
use \php\_Boot\HxAnon;
use \haxe\io\Error;
use \tink\streams\Handled;

class OutputSink extends SinkBase {
	/**
	 * @var string
	 */
	public $name;
	/**
	 * @var Output
	 */
	public $target;
	/**
	 * @var WorkerObject
	 */
	public $worker;


	/**
	 * @param string $name
	 * @param Output $target
	 * @param WorkerObject $worker
	 * 
	 * @return void
	 */
	public function __construct ($name, $target, $worker) {
		#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/OutputSink.hx:15: characters 5-21
		$this->name = $name;
		#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/OutputSink.hx:16: characters 5-25
		$this->target = $target;
		#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/OutputSink.hx:17: characters 5-25
		$this->worker = $worker;
	}


	/**
	 * @param StreamObject $source
	 * @param object $options
	 * 
	 * @return FutureObject
	 */
	public function consume ($source, $options) {
		#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/OutputSink.hx:20: lines 20-68
		$_gthis = $this;
		#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/OutputSink.hx:21: characters 5-28
		$rest = Chunk_Impl_::$EMPTY;
		#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/OutputSink.hx:23: lines 23-62
		$ret = $source->forEach(Handler_Impl_::ofUnknown(function ($c)  use (&$e1, &$e2, &$rest, &$e3, &$_gthis) {
			#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/OutputSink.hx:23: lines 23-62
			return Future_Impl_::async(function ($cb)  use (&$c, &$e1, &$e2, &$rest, &$e3, &$_gthis) {
				#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/OutputSink.hx:25: lines 25-26
				$pos = 0;
				#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/OutputSink.hx:25: lines 25-26
				$bytes = $c->toBytes();
				#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/OutputSink.hx:28: lines 28-59
				$write = null;
				#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/OutputSink.hx:28: lines 28-59
				$write = function ()  use (&$pos, &$write, &$bytes, &$e1, &$e2, &$rest, &$e3, &$_gthis, &$cb) {
					#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/OutputSink.hx:29: lines 29-58
					if ($pos === $bytes->length) {
						#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/OutputSink.hx:29: characters 34-44
						$cb(Handled::Resume());
					} else {
						#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/OutputSink.hx:30: lines 30-58
						Worker_Impl_::work($_gthis->worker, new LazyFunc(function ()  use (&$pos, &$bytes, &$e1, &$e2, &$e3, &$_gthis) {
							#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/OutputSink.hx:32: lines 32-47
							try {
								#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/OutputSink.hx:33: characters 15-73
								return Outcome::Success($_gthis->target->writeBytes($bytes, $pos, $bytes->length - $pos));
							} catch (\Throwable $__hx__caught_e) {
								$__hx__real_e = ($__hx__caught_e instanceof HxException ? $__hx__caught_e->e : $__hx__caught_e);
								if ($__hx__real_e instanceof Eof) {
									$e = $__hx__real_e;
									#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/OutputSink.hx:36: characters 15-26
									return Outcome::Success(-1);
								} else if ($__hx__real_e instanceof Error) {
									$e1 = $__hx__real_e;
									#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/OutputSink.hx:38: lines 38-41
									if ($e1->index === 0) {
										#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/OutputSink.hx:39: characters 29-39
										return Outcome::Success(0);
									} else {
										#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/OutputSink.hx:40: characters 24-76
										return Outcome::Failure(TypedError::withData(null, "Error writing to " . ($_gthis->name??'null'), $e1, new HxAnon([
											"fileName" => "tink/io/std/OutputSink.hx",
											"lineNumber" => 40,
											"className" => "tink.io.std.OutputSink",
											"methodName" => "consume",
										])));
									}
								} else if ($__hx__real_e instanceof TypedError) {
									$e2 = $__hx__real_e;
									#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/OutputSink.hx:43: characters 15-25
									return Outcome::Failure($e2);
								} else {
									$e3 = $__hx__real_e;
									#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/OutputSink.hx:46: characters 15-67
									return Outcome::Failure(TypedError::withData(null, "Error writing to " . ($_gthis->name??'null'), $e3, new HxAnon([
										"fileName" => "tink/io/std/OutputSink.hx",
										"lineNumber" => 46,
										"className" => "tink.io.std.OutputSink",
										"methodName" => "consume",
									])));
								}
							}
						}))->handle(function ($o)  use (&$pos, &$write, &$bytes, &$rest, &$cb) {
							#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/OutputSink.hx:48: lines 48-58
							switch ($o->index) {
								case 0:
									#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/OutputSink.hx:48: characters 38-39
									if ($o->params[0] === -1) {
										#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/OutputSink.hx:50: characters 20-58
										$rest = ByteChunk::of($bytes)->slice($pos, $bytes->length);
										#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/OutputSink.hx:51: characters 13-23
										$cb(Handled::Finish());
									} else {
										#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/OutputSink.hx:53: characters 13-21
										$pos = $pos + $o->params[0];
										#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/OutputSink.hx:54: lines 54-55
										if ($pos === $bytes->length) {
											#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/OutputSink.hx:54: characters 38-48
											$cb(Handled::Resume());
										} else {
											#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/OutputSink.hx:55: characters 18-25
											$write();
										}
									}
									break;
								case 1:
									#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/OutputSink.hx:57: characters 13-24
									$cb(Handled::Clog($o->params[0]));
									break;
							}
						});
					}
				};
				#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/OutputSink.hx:61: characters 7-14
				$write();
			});
		}));
		#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/OutputSink.hx:64: lines 64-65
		if (($options !== null) && $options->end) {
			#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/OutputSink.hx:65: characters 7-73
			$ret->handle(function ($end)  use (&$_gthis) {
				#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/OutputSink.hx:65: characters 33-72
				try {
					#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/OutputSink.hx:65: characters 37-51
					$_gthis->target->close();
				} catch (\Throwable $__hx__caught_e) {
					$__hx__real_e = ($__hx__caught_e instanceof HxException ? $__hx__caught_e->e : $__hx__caught_e);
					$e4 = $__hx__real_e;
									}
			});
		}
		#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/OutputSink.hx:67: characters 12-64
		return $ret->map(function ($c1)  use (&$rest) {
			#/Users/ut/haxe/haxe_libraries/tink_io/0.6.2/haxelib/src/tink/io/std/OutputSink.hx:67: characters 33-63
			return PipeResultTools::toResult($c1, Noise::Noise(), $rest);
		})->gather();
	}
}


Boot::registerClass(OutputSink::class, 'tink.io.std.OutputSink');
